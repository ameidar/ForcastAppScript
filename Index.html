<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <!-- התאמה למסכים ניידים -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base target="_top">
    <title>דרך ההייטק בע״מ ח.פ 516045564</title>
    <!-- גופן מודרני -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- טעינת Google Charts (אם נדרש לגרפים) -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {packages:['corechart']});
    </script>
    <style>
      body {
        direction: rtl;
        font-family: 'Rubik', sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        color: #e6e6e6;
        min-height: 100vh;
        line-height: 1.8;
        font-weight: 300;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 30px;
        position: relative;
        z-index: 1;
      }
      
      /* Glowing background effect */
      .container::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, rgba(32, 129, 226, 0.08) 0%, rgba(0, 0, 0, 0) 70%);
        pointer-events: none;
        z-index: -1;
      }
      
      header {
        text-align: center;
        margin-bottom: 40px;
        position: relative;
        padding: 30px;
        border-radius: 20px;
        background: rgba(26, 26, 46, 0.6);
        box-shadow: 0 8px 32px rgba(0, 200, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      
      header h1 {
        font-size: 2.4em;
        margin: 15px 0 0;
        text-shadow: 0 0 15px rgba(0, 200, 255, 0.5);
        font-weight: 500;
        letter-spacing: 0.5px;
      }
      
      .company-logo {
        max-width: 120px;
        margin-bottom: 15px;
        border-radius: 50%;
        box-shadow: 0 0 25px rgba(0, 200, 255, 0.4);
        transition: transform 0.3s ease;
      }
      
      .company-logo:hover {
        transform: scale(1.05);
      }
      
      .section {
        background: rgba(26, 26, 46, 0.6);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        position: relative;
        box-shadow: 0 8px 32px rgba(0, 200, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      
      .section:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 200, 255, 0.15);
      }
      
      .section h2 {
        margin-top: 0;
        font-size: 1.8em;
        color: #4cc9f0;
        text-shadow: 0 0 10px rgba(76, 201, 240, 0.3);
        border-bottom: 1px solid rgba(76, 201, 240, 0.2);
        padding-bottom: 15px;
        font-weight: 500;
        letter-spacing: 0.5px;
      }
      
      label {
        display: block;
        margin-bottom: 20px;
        color: #b8c1ec;
        font-size: 1.1em;
        font-weight: 400;
      }
      
      input[type="month"],
      input[type="number"],
      input[type="date"],
      input[type="text"],
      select {
        width: 100%;
        max-width: 300px;
        padding: 12px 15px;
        margin-bottom: 20px;
        border: none;
        border-radius: 12px;
        font-size: 1em;
        font-family: 'Rubik', sans-serif;
        background: rgba(26, 26, 46, 0.8);
        color: #4cc9f0;
        box-shadow: 0 4px 12px rgba(0, 200, 255, 0.1);
        transition: all 0.3s ease;
        border: 1px solid rgba(76, 201, 240, 0.2);
      }
      
      input:focus, select:focus {
        outline: none;
        box-shadow: 0 0 20px rgba(76, 201, 240, 0.2);
        border-color: rgba(76, 201, 240, 0.4);
        transform: translateY(-2px);
      }
      
      .button-group {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      
      button {
        padding: 14px 28px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(45deg, #4361ee, #4cc9f0);
        color: white;
        font-size: 1.1em;
        font-weight: 500;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        font-family: 'Rubik', sans-serif;
        letter-spacing: 0.5px;
      }
      
      button:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(67, 97, 238, 0.4);
      }
      
      button:active:not(:disabled) {
        transform: translateY(-1px);
      }
      
      button:disabled {
        background: #2a2a42;
        cursor: not-allowed;
        color: #6e6e8a;
        box-shadow: none;
      }
      
      #loadingSpinner {
        display: none;
        margin: 20px 0;
        padding: 15px;
        border-radius: 12px;
        background: rgba(26, 26, 46, 0.6);
        color: #4cc9f0;
        text-align: center;
        animation: pulse 1.5s infinite;
        font-weight: 400;
      }
      
      @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
      }
      
      #results, #compareResults, #pastResults, #annualBranchResults, #activeCyclesResults, #analysisResults {
        margin-top: 20px;
        background: rgba(10, 22, 42, 0.8);
        color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 200, 255, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 200, 255, 0.3);
        text-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
        line-height: 1.7;
      }
      
      /* הדגשות וכותרות בתוך אזורי התוצאות */
      #results h3, #compareResults h3, #pastResults h3, #annualBranchResults h3, #activeCyclesResults h3, #analysisResults h3 {
        color: #4cc9f0;
        text-shadow: 0 0 10px rgba(76, 201, 240, 0.3);
        margin-top: 0;
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 1.6em;
      }
      
      /* כותרות משנה באזורי התוצאות */
      #results h4, #compareResults h4, #pastResults h4, #annualBranchResults h4, #activeCyclesResults h4, #analysisResults h4 {
        color: #7dd3f7;
        text-shadow: 0 0 8px rgba(76, 201, 240, 0.2);
        margin-top: 20px;
        margin-bottom: 15px;
        font-weight: 400;
      }
      
      /* עיצוב ערכים מודגשים */
      #results b, #compareResults b, #pastResults b, #annualBranchResults b, #activeCyclesResults b, #analysisResults b {
        color: #70e0ff;
        text-shadow: 0 0 2px rgba(0, 200, 255, 0.3);
      }
      
      #results table, #compareResults table, #pastResults table, #annualBranchResults table, #activeCyclesResults table, #analysisResults table {
        background: rgba(0, 10, 30, 0.95);
      }
      
      /* Tables styling */
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 20px;
        background: rgba(26, 26, 46, 0.8);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 200, 255, 0.1);
      }
      
      th {
        background: rgba(67, 97, 238, 0.3);
        color: #4cc9f0;
        padding: 15px;
        text-align: center;
        font-weight: 500;
        font-size: 1.1em;
      }
      
      td {
        padding: 12px;
        text-align: center;
        border-top: 1px solid rgba(76, 201, 240, 0.1);
        color: #e6e6e6;
        font-weight: 300;
      }
      
      tr:hover td {
        background: rgba(67, 97, 238, 0.1);
      }
      
      /* Chart container */
      #chartContainer {
        width: 100%;
        height: 400px;
        background: rgba(1, 13, 32, 0.6);
        margin-top: 20px;
        border-radius: 8px;
        display: none;
        box-shadow: 0 0 15px rgba(0, 200, 255, 0.2);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(0, 200, 255, 0.2);
        padding: 15px;
      }
      
      /* Toast notification */
      #notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 17, 46, 0.9);
        color: #00eaff;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 200, 255, 0.4);
        z-index: 1000;
        display: none;
        backdrop-filter: blur(10px);
        border-left: 4px solid #00eaff;
        animation: slideInRight 0.5s forwards;
        max-width: 400px;
      }
      
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      /* Responsive styles */
      @media (max-width: 768px) {
        .container { padding: 20px; }
        header h1 { font-size: 2em; }
        .company-logo { max-width: 100px; }
        button { width: 100%; margin-bottom: 15px; }
        .button-group { flex-direction: column; gap: 15px; }
        #chartContainer { height: 300px; }
        .section { padding: 20px; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <img src="https://static.wixstatic.com/media/85929f_9025e84d08eb4a4d9aafc66d74cbc29c~mv2.jpeg/v1/fill/w_1080,h_1080,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/logo_haitech-09_converted.jpeg" alt="לוגו דרך ההייטק" class="company-logo">
        <h1>דרך ההייטק בע״מ ח.פ 516045564</h1>
      </header>
      
      <!-- אזור התחזית העתידית (יומי, שבועי, חודשי) -->
      <div class="section" id="forecastSection">
        <h2>חישוב תחזית עתידית</h2>
        <label>בחר חודש (עבור שבועי/חודשי):
          <input type="month" id="monthInput" value="2025-04">
        </label>
        <label>מספר שבוע (1-5):
          <input type="number" id="weekInput" min="1" max="5" value="1">
        </label>
        <label>סווג לפי (עבור שבועי/חודשי):
          <select id="sivugSelect">
            <option value="cycle">לפי פעילות (סוג המחזור)</option>
            <option value="lesson">לפי סוג ההדרכה</option>
            <option value="branch">לפי סניף במחזור</option>
          </select>
        </label>
        <button id="weeklyBtn" onclick="runWeeklyCalc()">הצג תחזית שבועית</button>
        <button id="monthlyBtn" onclick="runMonthlyCalc()">הצג תחזית חודשית</button>
        <hr>
        <label>בחר תאריך ספציפי (עבור יומי):
          <input type="date" id="dayInput" value="2025-04-10">
        </label>
        <button id="dailyBtn" onclick="runDailyCalc()">הצג תחזית יומית</button>
        <div id="loadingSpinner">טוען נתונים... אנא המתן</div>
        <div id="results"></div>
        <button id="chartBtn" onclick="renderForecastChart()">הצג גרף</button>
        <div id="chartContainer"></div>
      </div>
      
      <!-- אזור ייצוא דוח התחזית העתידית -->
      <div class="section" id="exportSection">
        <h2>ייצוא דוח תחזית עתידית</h2>
        <label>שם הדוח (אם ריק, ייבנה אוטומטית לפי הבחירה):
          <input type="text" id="reportName" placeholder="לדוגמה: תחזית חודשית 2025-04 (branch)">
        </label>
        <button id="exportBtn" onclick="exportForecast()">ייצא לדוח בגוגל שיטס</button>
      </div>
      
      <!-- אזור חישוב נתוני פגישות עבר -->
      <div class="section" id="pastSection">
        <h2>חישוב נתוני פגישות עבר</h2>
        <label>בחר תאריך התחלה:
          <input type="date" id="pastStartDate" value="2025-03-01">
        </label>
        <label>בחר תאריך סיום:
          <input type="date" id="pastEndDate" value="2025-03-31">
        </label>
        <label>סיווג לפי:
          <select id="pastSivugSelect">
            <option value="cycle">לפי פעילות (סוג המחזור)</option>
            <option value="lesson">לפי סוג ההדרכה</option>
            <option value="branch">לפי סניף במחזור</option>
          </select>
        </label>
        <button id="pastCalcBtn" onclick="runPastCalc()">הצג נתוני פגישות עבר</button>
        <div id="pastResults"></div>
        <button id="pastExportBtn" onclick="exportPastForecast()">ייצא לדוח פגישות עבר בגוגל שיטס</button>
      </div>
      
      <!-- אזור השוואת חודשים לפי סניף -->
      <div class="section" id="compareSection">
        <h2>השוואת חודשים לפי סניף</h2>
        <label>בחר חודש ראשון:
          <input type="month" id="compareMonth1" value="2025-04">
        </label>
        <label>בחר חודש שני:
          <input type="month" id="compareMonth2" value="2025-05">
        </label>
        <button id="compareBtn" onclick="runCompare()">השווה חודשים לפי סניף</button>
        <div id="compareResults"></div>
        <button id="exportCompareBtn" onclick="exportCompare()">ייצא דוח השוואה</button>
      </div>

      <div class="section" id="analysisSection">
        <h2>ניתוח השוואת חודשים לפי סניף</h2>
        <button id="analyzeBtn" onclick="analyzeCompare()">נתח את הטבלה</button>
        <div id="analysisResults"></div>
      </div>

      
      <div class="section" id="branchCalculationSection">
          <h2>חישוב הכנסה שנתית לפי סניף</h2>
          <label>בחר סניף:
            <select id="branchSelect"></select>
          </label>
          <label>בחר תאריך התחלה:
            <input type="date" id="yearlyStartDate" value="2024-09-01">
          </label>
          <label>בחר תאריך סיום:
            <input type="date" id="yearlyEndDate" value="2025-06-30">
          </label>
          <button id="annualBranchBtn" onclick="runAnnualBranchCalc()">חשב הכנסה שנתית</button>
          <div id="annualBranchResults"></div>
      </div>

      <div class="section" id="activeCyclesSection">
        <h2>מחזורים</h2>
        <div class="button-group" style="display: flex; gap: 10px; margin-bottom: 15px;">
          <button id="showActiveCyclesBtn" onclick="showActiveCycles()">הצג מחזורים פעילים</button>
          <button id="showEndedCyclesBtn" onclick="showEndedCycles()">הצג מחזורים שהסתיימו</button>
          <button id="showEndingThisMonthBtn" onclick="showEndingThisMonth()">הצג מחזורים שמסתיימים החודש</button>
        </div>
        <div id="activeCyclesResults"></div>
      </div>

      <!-- הוספת אזור חדש להזמנות מוסדיות -->
      <div class="section" id="institutionalOrdersSection">
        <h2>הזמנות מוסדיות</h2>
        <div class="button-group">
          <button id="showInstitutionalOrdersBtn" onclick="showInstitutionalOrders()">הצג הזמנות מוסדיות בסטטוס מעקב וגבייה</button>
        </div>
        <div id="institutionalOrdersResults"></div>
      </div>

      <!-- הוספת אזור חדש להשוואת תאריכי סיום -->
      <div class="section" id="cycleEndDateSection">
        <h2>השוואת תאריכי סיום מחזורים</h2>
        <div class="button-group">
          <button id="compareCycleEndDatesBtn" onclick="showCycleEndDateComparison()">הצג מחזורים עם פער בין תאריך סיום לפגישה אחרונה</button>
        </div>
        <div id="cycleEndDateResults"></div>
      </div>

      <!-- הוספת אזור חדש לצ'אטבוט -->
      <div class="section" id="chatbotSection">
        <h2>צ'אטבוט חכם</h2>
        <div id="chatContainer" style="height: 400px; overflow-y: auto; margin-bottom: 20px; padding: 10px; background: rgba(0, 10, 30, 0.5); border-radius: 10px;">
          <div id="chatMessages"></div>
        </div>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="chatInput" placeholder="שאל שאלה על פגישות..." style="flex-grow: 1;">
          <button onclick="sendChatMessage()" id="sendChatBtn">שלח</button>
        </div>
      </div>

      <!-- הוספת אזור חדש להרשמות לקורסים דיגיטליים -->
      <div class="section" id="digitalCoursesSection">
        <h2>הרשמות לקורסים דיגיטליים</h2>
        <div class="button-group">
          <button id="showDigitalRegistrationsBtn" onclick="showDigitalRegistrations()">הצג הרשמות לקורסים דיגיטליים</button>
        </div>
        <div id="digitalRegistrationsResults"></div>
      </div>

    </div>
    
    <!-- Toast notification -->
    <div id="notification"></div>
    
    <script>
      var forecastResult = null;
      var compareResult = null;
      var pastResult = null;
      var forecastType = ""; // "weekly", "monthly", "daily"
      
      function showNotification(messageHtml) {
        var notificationDiv = document.getElementById("notification");
        notificationDiv.innerHTML = messageHtml;
        notificationDiv.style.display = "block";
        setTimeout(function(){
          notificationDiv.style.display = "none";
        }, 5000);
      }
      
      function disableForecastButtons() {
        document.getElementById("weeklyBtn").disabled = true;
        document.getElementById("monthlyBtn").disabled = true;
        document.getElementById("dailyBtn").disabled = true;
        document.getElementById("exportBtn").disabled = true;
        document.getElementById("chartBtn").disabled = true;
        document.getElementById("compareBtn").disabled = true;
        document.getElementById("pastCalcBtn").disabled = true;
        document.getElementById("pastExportBtn").disabled = true;
        document.getElementById("exportCompareBtn").disabled = true;
        document.getElementById("annualBranchBtn").disabled = true;
        document.getElementById("showActiveCyclesBtn").disabled = true;
        document.getElementById("showEndedCyclesBtn").disabled = true;
        document.getElementById("showInstitutionalOrdersBtn").disabled = true;
        document.getElementById("compareCycleEndDatesBtn").disabled = true;
        document.getElementById("showDigitalRegistrationsBtn").disabled = true;
      }
      
      function enableForecastButtons() {
        document.getElementById("weeklyBtn").disabled = false;
        document.getElementById("monthlyBtn").disabled = false;
        document.getElementById("dailyBtn").disabled = false;
        document.getElementById("exportBtn").disabled = false;
        document.getElementById("chartBtn").disabled = false;
        document.getElementById("compareBtn").disabled = false;
        document.getElementById("pastCalcBtn").disabled = false;
        document.getElementById("pastExportBtn").disabled = false;
        document.getElementById("exportCompareBtn").disabled = false;
        document.getElementById("annualBranchBtn").disabled = false;
        document.getElementById("showActiveCyclesBtn").disabled = false;
        document.getElementById("showEndedCyclesBtn").disabled = false;
        document.getElementById("showInstitutionalOrdersBtn").disabled = false;
        document.getElementById("compareCycleEndDatesBtn").disabled = false;
        document.getElementById("showDigitalRegistrationsBtn").disabled = false;
      }
      
      // ---- חישוב תחזית עתידית ----
      function runWeeklyCalc() {
        forecastType = "weekly";
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("results").innerHTML = "";
        document.getElementById("chartContainer").style.display = "none";
        
        const monthVal = document.getElementById("monthInput").value;
        const weekVal  = document.getElementById("weekInput").value;
        const sivug    = document.getElementById("sivugSelect").value;
        
        google.script.run
          .withSuccessHandler(displayResults(monthVal + ", שבוע " + weekVal, sivug))
          .withFailureHandler(displayError)
          .calcWeeklyForecastSS(monthVal, weekVal, sivug);
      }
      
      function runMonthlyCalc() {
        forecastType = "monthly";
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("results").innerHTML = "";
        document.getElementById("chartContainer").style.display = "none";
        
        const monthVal = document.getElementById("monthInput").value;
        const sivug = document.getElementById("sivugSelect").value;
        
        google.script.run
          .withSuccessHandler(displayResults(monthVal, sivug))
          .withFailureHandler(displayError)
          .calcMonthlyForecastSS(monthVal, sivug);
      }
      
      function runDailyCalc() {
        forecastType = "daily";
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("results").innerHTML = "";
        document.getElementById("chartContainer").style.display = "none";
        
        const dayVal = document.getElementById("dayInput").value;
        
        google.script.run
          .withSuccessHandler(function(response){
            document.getElementById("loadingSpinner").style.display = "none";
            if (!response || !response.success) {
              document.getElementById("results").innerHTML = "שגיאה בחישוב יומי!";
              enableForecastButtons();
              return;
            }
            forecastResult = response;
            let html = "<h3>תחזית יומית: " + dayVal + "</h3>";
            html += "סך הכנסה: " + response.totalRevenue.toFixed(2) + "<br>";
            html += "סך הוצאה: " + response.totalCost.toFixed(2);
            document.getElementById("results").innerHTML = html;
            enableForecastButtons();
          })
          .withFailureHandler(function(err){
            displayError(err);
            enableForecastButtons();
          })
          .calcDailyForecastSS(dayVal);
      }
      
      // ---- הצגת גרף ----
      function renderForecastChart() {
        if (!forecastResult) {
          showNotification("אין תוצאה לחישוב. נא לחשב תחזית תחילה.");
          return;
        }
        
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'קטגוריה');
        data.addColumn('number', 'סכום');
        
        const sivug = document.getElementById("sivugSelect").value;
        
        if (sivug === "cycle") {
          data.addRow(["פרטי", forecastResult.privateSum || 0]);
          data.addRow(["מוסדי", forecastResult.mosediSum || 0]);
          data.addRow(["מוסדי פר ילד", forecastResult.mosediChildSum || 0]);
        } else if (sivug === "lesson" && response.frontaliCount !== undefined) {
          data.addRow(["שיעור פרונטאלי", forecastResult.frontaliSum || 0]);
          data.addRow(["שיעור פרטי", forecastResult.privateLessonSum || 0]);
          data.addRow(["אונליין קבוצתי", forecastResult.onlineSum || 0]);
          data.addRow(["תמיכה או בניית חומרים", forecastResult.supportSum || 0]);
        } else if (sivug === "branch" && response.branchDetails) {
          data.addRow(["אין סניפים", 0]);
        } else {
          data.addRow(["הכנסה", forecastResult.totalRevenue || 0]);
          data.addRow(["הוצאה", forecastResult.totalCost || 0]);
        }
        
        var options = {
          title: "תרשים תחזית",
          backgroundColor: "#f8f8f8",
          legend: { position: "right" },
          hAxis: { title: "סכום (₪)", minValue: 0 },
          chartArea: { left: 100, top: 50, width: '60%', height: '70%' }
        };
        
        document.getElementById("chartContainer").style.display = "block";
        var chart = new google.visualization.BarChart(document.getElementById("chartContainer"));
        chart.draw(data, options);
      }
      
      // ---- חישוב נתוני פגישות עבר ----
      function runPastCalc() {
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("pastResults").innerHTML = "";
        
        const startDate = document.getElementById("pastStartDate").value;
        const endDate = document.getElementById("pastEndDate").value;
        const sivug = document.getElementById("pastSivugSelect").value;
        
        var startDateStr = startDate + "T00:00:00";
        var endDateStr = endDate + "T00:00:00";
        
        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById("loadingSpinner").style.display = "none";
            if (!response || !response.success) {
              document.getElementById("pastResults").innerHTML = "שגיאה בחישוב נתוני פגישות עבר!";
              enableForecastButtons();
              return;
            }
            pastResult = response;
            let html = "<h3>חישוב נתוני פגישות עבר</h3>";
            html += "סך הכנסה: " + response.totalIncome.toFixed(2) + "<br>";
            html += "סך תשלום: " + response.totalPayment.toFixed(2) + "<br>";
            html += "סך רווח: " + response.totalProfit.toFixed(2) + "<br><br>";
            html += "<b>פירוט לפי " + (sivug === "branch" ? "סניף" : sivug === "lesson" ? "סוג הדרכה" : "סוג מחזור") + ":</b><br>";
            if (response.breakdown && response.breakdown.length > 0) {
              response.breakdown.forEach(function(item) {
                html += item.group + ": " + item.count + " מפגשים, ";
                html += "הכנסה: " + item.income.toFixed(2) + ", ";
                html += "תשלום: " + item.payment.toFixed(2) + ", ";
                html += "רווח: " + item.profit.toFixed(2) + "<br>";
              });
            } else {
              html += "אין נתונים לפירוט.<br>";
            }
            document.getElementById("pastResults").innerHTML = html;
            enableForecastButtons();
          })
          .withFailureHandler(function(err) {
            displayError(err);
            enableForecastButtons();
          })
          .calcPastForecast(startDateStr, endDateStr, sivug);
      }
      
      // ---- ייצוא דוח תחזית עתידית ----
      function exportForecast() {
        if (!forecastResult) {
          showNotification("אין תוצאה לייצוא. נא לחשב תחזית תחילה.");
          return;
        }
        let reportNameInput = document.getElementById("reportName").value.trim();
        let reportName = reportNameInput;
        const sivug = document.getElementById("sivugSelect").value;
        
        if (!reportName) {
          if (forecastType === "monthly") {
            const monthVal = document.getElementById("monthInput").value;
            reportName = "תחזית חודשית " + monthVal + " (" + sivug + ")";
          } else if (forecastType === "weekly") {
            const monthVal = document.getElementById("monthInput").value;
            const weekVal = document.getElementById("weekInput").value;
            reportName = "תחזית שבועית " + monthVal + ", שבוע " + weekVal + " (" + sivug + ")";
          } else if (forecastType === "daily") {
            const dayVal = document.getElementById("dayInput").value;
            reportName = "תחזית יומית " + dayVal + " (" + sivug + ")";
          } else {
            reportName = "Forecast Report";
          }
        }
        
        disableForecastButtons();
        google.script.run
          .withSuccessHandler(function(url) {
            enableForecastButtons();
            showNotification('הדוח נוצר בהצלחה! לחץ <a href="' + url + '" target="_blank" style="color:#ff9800; text-decoration:underline;">כאן</a> לגישה לדוח.<br>כתובת הקובץ: <a href="' + url + '" target="_blank" style="color:#ff9800; text-decoration:underline;">' + url + '</a>');
          })
          .withFailureHandler(function(err) {
            enableForecastButtons();
            showNotification("שגיאה ביצוא: " + JSON.stringify(err));
          })
          .exportForecastToNewSheet(forecastResult, reportName);
      }

      function exportCompare() {
        if (!compareResult) {
          showNotification("אין תוצאה לייצוא. נא לחשב השוואת חודשים תחילה.");
          return;
        }
        disableForecastButtons();
        google.script.run
          .withSuccessHandler(function(url) {
            enableForecastButtons();
            showNotification('דוח השוואה נוצר בהצלחה! לחץ <a href="' + url + '" target="_blank" style="color:#ff9800; text-decoration:underline;">כאן</a> לגישה לדוח.');
          })
          .withFailureHandler(function(err) {
            enableForecastButtons();
            showNotification("שגיאה ביצוא דוח השוואה: " + JSON.stringify(err));
          })
          .exportCompareToSheet(compareResult, "דוח השוואת חודשים");
      }

      function analyzeCompare() {
        if (!compareResult) {
          showNotification("אנא חשב קודם את השוואת החודשים.");
          return;
        }
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        
        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById("loadingSpinner").style.display = "none";
            if (!response || !response.success) {
              showNotification("אירעה שגיאה בניתוח.");
            } else {
              // Display the analysis in a new div with id "analysisResults"
              document.getElementById("analysisResults").innerHTML = "<h3>ניתוח השוואה:</h3>" + response.analysis;
            }
            enableForecastButtons();
          })
          .withFailureHandler(function(err) {
            document.getElementById("loadingSpinner").style.display = "none";
            showNotification("שגיאה בניתוח: " + JSON.stringify(err));
            enableForecastButtons();
          })
          .analyzeComparisonByBranch(compareResult);
      }

      // ---- ייצוא דוח נתוני פגישות עבר ----
      function exportPastForecast() {
        if (!pastResult) {
          showNotification("אין תוצאה לייצוא. נא לחשב נתוני פגישות עבר תחילה.");
          return;
        }
        const startDate = document.getElementById("pastStartDate").value;
        const endDate = document.getElementById("pastEndDate").value;
        const sivug = document.getElementById("pastSivugSelect").value;
        let reportName = "נתוני פגישות עבר " + startDate + " עד " + endDate + " (" + sivug + ")";
        
        disableForecastButtons();
        google.script.run
          .withSuccessHandler(function(url) {
            enableForecastButtons();
            showNotification('דוח נתוני פגישות עבר נוצר בהצלחה! לחץ <a href="' + url + '" target="_blank" style="color:#ff9800; text-decoration:underline;">כאן</a> לגישה לדוח.<br>כתובת הקובץ: <a href="' + url + '" target="_blank" style="color:#ff9800; text-decoration:underline;">' + url + '</a>');
          })
          .withFailureHandler(function(err) {
            enableForecastButtons();
            showNotification("שגיאה ביצוא נתוני פגישות עבר: " + JSON.stringify(err));
          })
          .exportPastForecastToNewSheet(pastResult, reportName);
      }
      
      // ---- השוואת חודשים לפי סניף ----
      function runCompare() {
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("compareResults").innerHTML = "";
        
        const month1 = document.getElementById("compareMonth1").value;
        const month2 = document.getElementById("compareMonth2").value;
        
        google.script.run
          .withSuccessHandler(displayCompareResults)
          .withFailureHandler(displayError)
          .compareMonthlyForecastByBranch(month1, month2);
      }
      
      function runAnnualBranchCalc() {
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("annualBranchResults").innerHTML = "";
        
        var branchId = document.getElementById("branchSelect").value;
        var startDate = document.getElementById("yearlyStartDate").value;
        var endDate = document.getElementById("yearlyEndDate").value;
        var startDateStr = startDate + "T00:00:00";
        var endDateStr = endDate + "T23:59:59";
        
        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById("loadingSpinner").style.display = "none";
            if (!response || !response.success) {
              document.getElementById("annualBranchResults").innerHTML = "שגיאה בחישוב השנתי!";
              enableForecastButtons();
              return;
            }
            let html = "<h3>סיכום שנתי עבור הסניף: " +
                      document.getElementById("branchSelect").options[document.getElementById("branchSelect").selectedIndex].text +
                      "</h3>";
            html += "מספר פגישות: " + response.meetingCount + "<br>";
            html += "סך הכנסה: " + response.income.toFixed(2) + "<br>";
            html += "סך תשלום: " + response.cost.toFixed(2) + "<br>";
            html += "סך רווח: " + response.profit.toFixed(2) + "<br><br>";
            
            // הצגת פרטי הפגישות בטבלה
            if (response.meetingDetails && response.meetingDetails.length > 0) {
              html += "<h4>פרטי פגישות:</h4>";
              html += "<table border='1' cellpadding='5' cellspacing='0' style='width:100%;'>";
              html += "<tr><th>תאריך פגישה</th><th>שעת התחלה</th><th>שם מדריך</th><th>הכנסה</th><th>תשלום</th><th>רווח</th></tr>";
              response.meetingDetails.forEach(function(detail) {
                html += "<tr>";
                html += "<td>" + detail.meetingDate + "</td>";
                html += "<td>" + detail.startTime + "</td>";
                html += "<td>" + detail.guideName + "</td>";
                html += "<td>" + parseFloat(detail.income).toFixed(2) + "</td>";
                html += "<td>" + parseFloat(detail.cost).toFixed(2) + "</td>";
                html += "<td>" + parseFloat(detail.profit).toFixed(2) + "</td>";
                html += "</tr>";
              });
              html += "</table>";
            } else {
              html += "אין פרטי פגישות.";
            }
            
            document.getElementById("annualBranchResults").innerHTML = html;
            enableForecastButtons();
          })
          .withFailureHandler(function(err) {
            document.getElementById("loadingSpinner").style.display = "none";
            document.getElementById("annualBranchResults").innerHTML = "שגיאה: " + err.message;
            enableForecastButtons();
          })
          .calcBranchIncomeForPeriod(branchId, startDateStr, endDateStr);
      }

      function displayResults(title, sivug) {
        return function(response) {
          document.getElementById("loadingSpinner").style.display = "none";
          if (!response || !response.success) {
            document.getElementById("results").innerHTML = "שגיאה בחישוב!";
            enableForecastButtons();
            return;
          }
          let html = "<h3>תחזית: " + title + "</h3>";
          html += "סך הכנסה: " + (response.totalRevenue || 0).toFixed(2) + "<br>";
          html += "סך הוצאה: " + (response.totalCost || 0).toFixed(2) + "<br><br>";
          
          if (sivug === "cycle" && response.privateCount !== undefined) {
            html += "<h4>סיווג לפי סוג מחזור:</h4>";
            html += "פרטי: " + response.privateCount + " מפגשים, הכנסה: " + (response.privateSum || 0).toFixed(2) + "<br>";
            html += "מוסדי: " + response.mosediCount + " מפגשים, הכנסה: " + (response.mosediSum || 0).toFixed(2) + "<br>";
            html += "מוסדי פר ילד: " + response.mosediChildCount + " מפגשים, הכנסה: " + (response.mosediChildSum || 0).toFixed(2) + "<br>";
          } else if (sivug === "lesson" && response.frontaliCount !== undefined) {
            html += "<h4>סיווג לפי סוג ההדרכה:</h4>";
            html += "שיעור פרונטאלי: " + response.frontaliCount + " מפגשים, הכנסה: " + (response.frontaliSum || 0).toFixed(2) + "<br>";
            html += "שיעור פרטי: " + response.privateLessonCount + " מפגשים, הכנסה: " + (response.privateLessonSum || 0).toFixed(2) + "<br>";
            html += "אונליין קבוצתי: " + response.onlineCount + " מפגשים, הכנסה: " + (response.onlineSum || 0).toFixed(2) + "<br>";
            html += "תמיכה: " + response.supportCount + " מפגשים, הכנסה: " + (response.supportSum || 0).toFixed(2) + "<br>";
          } else if (sivug === "branch" && response.branchDetails) {
            html += "<h4>סיווג לפי סניף:</h4>";
            html += "<table border='1' cellpadding='5' cellspacing='0' style='width:100%;'>";
            html += "<tr><th>סניף</th><th>מפגשים</th><th>הכנסה</th></tr>";
            response.branchDetails.forEach(function(bd) {
              html += "<tr><td>" + bd.branchName + "</td><td>" + bd.count + "</td><td>" + (bd.sumRevenue || 0).toFixed(2) + "</td></tr>";
            });
            html += "</table>";
          }
          document.getElementById("results").innerHTML = html;
          enableForecastButtons();
        };
      }

      function displayCompareResults(response) {
        document.getElementById("loadingSpinner").style.display = "none";
        if (!response || !response.success) {
          document.getElementById("compareResults").innerHTML = "שגיאה בהשוואה!";
          enableForecastButtons();
          return;
        }
        compareResult = response;
        let html = "<h3>השוואת חודשים: " + response.month1 + " מול " + response.month2 + " (סניף)</h3>";
        html += "<table border='1' cellpadding='5' cellspacing='0' style='width:100%;'>";
        html += "<tr><th>סניף</th><th>הכנסה (" + response.month1 + ")</th><th>הכנסה (" + response.month2 + ")</th><th>הפרש</th><th>% שינוי</th></tr>";
        
        if (response.comparison && response.comparison.length > 0) {
          response.comparison.forEach(function(row) {
            html += "<tr>";
            html += "<td>" + row[0] + "</td>";
            html += "<td>" + parseFloat(row[1]).toFixed(2) + "</td>";
            html += "<td>" + parseFloat(row[2]).toFixed(2) + "</td>";
            html += "<td>" + parseFloat(row[3]).toFixed(2) + "</td>";
            html += "<td>" + parseFloat(row[4]).toFixed(2) + "%</td>";
            html += "</tr>";
          });
        } else {
          html += "<tr><td colspan='5'>אין נתונים להשוואה</td></tr>";
        }
        html += "</table>";
        document.getElementById("compareResults").innerHTML = html;
        enableForecastButtons();
      }
      
      function displayError(err) {
        document.getElementById("loadingSpinner").style.display = "none";
        document.getElementById("results").innerHTML = "שגיאה: " + err.message;
        enableForecastButtons();
      }

      // טעינת רשימת הסניפים עם טעינת הדף
      window.onload = function() {
        google.script.run
          .withSuccessHandler(populateBranchDropdown)
          .withFailureHandler(displayError)
          .getBranchList();
      };

      function populateBranchDropdown(branches) {
        var select = document.getElementById("branchSelect");
        if (branches && branches.length > 0) {
          branches.forEach(function(branch) {
            var option = document.createElement("option");
            option.value = branch.id;
            option.text = branch.name;
            select.add(option);
          });
        } else {
          console.error("לא נמצאו סניפים");
        }
      }

      function sortCyclesByEndDate(cycles) {
        return cycles.sort((a, b) => {
          const getEndDate = (cycle) => {
            const endDateStr = cycle.EndDate || cycle.pcfsystemfield35;
            if (!endDateStr) return new Date(0);
            return new Date(endDateStr);
          };

          const dateA = getEndDate(a);
          const dateB = getEndDate(b);
          return dateA - dateB; // מהקרוב לרחוק
        });
      }

      function showActiveCycles() {
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("activeCyclesResults").innerHTML = "";
        
        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById("loadingSpinner").style.display = "none";
            
            if (!response || response.length === 0) {
              document.getElementById("activeCyclesResults").innerHTML = "לא נמצאו מחזורים פעילים";
              enableForecastButtons();
              return;
            }

            // מיון המחזורים לפי תאריך סיום
            const sortedCycles = sortCyclesByEndDate(response);
            displayCycles(sortedCycles, "מחזורים פעילים");
            enableForecastButtons();
          })
          .withFailureHandler(function(err) {
            document.getElementById("loadingSpinner").style.display = "none";
            document.getElementById("activeCyclesResults").innerHTML = "שגיאה בטעינת מחזורים פעילים: " + err;
            enableForecastButtons();
          })
          .printActiveCycles();
      }

      function showEndedCycles() {
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("activeCyclesResults").innerHTML = "";
        
        const startDate = "2024-09-01";
        const today = new Date();
        const endDate = today.toISOString().split('T')[0];
        
        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById("loadingSpinner").style.display = "none";
            
            if (!response || response.length === 0) {
              document.getElementById("activeCyclesResults").innerHTML = "לא נמצאו מחזורים שהסתיימו";
              enableForecastButtons();
              return;
            }

            // מיון המחזורים לפי תאריך סיום
            const sortedCycles = sortCyclesByEndDate(response);
            displayCycles(sortedCycles, "מחזורים שהסתיימו");
            enableForecastButtons();
          })
          .withFailureHandler(function(err) {
            document.getElementById("loadingSpinner").style.display = "none";
            document.getElementById("activeCyclesResults").innerHTML = "שגיאה בטעינת מחזורים שהסתיימו: " + err;
            enableForecastButtons();
          })
          .printEndedCycles(startDate, endDate);
      }

      function showEndingThisMonth() {
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("activeCyclesResults").innerHTML = "";
        
        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById("loadingSpinner").style.display = "none";
            
            if (!response || response.length === 0) {
              document.getElementById("activeCyclesResults").innerHTML = "לא נמצאו מחזורים פעילים";
              enableForecastButtons();
              return;
            }

            // סינון מחזורים שמסתיימים החודש
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const endingThisMonth = response.filter(cycle => {
              const endDate = new Date(cycle.EndDate || cycle.pcfsystemfield35);
              return endDate.getMonth() === currentMonth && 
                     endDate.getFullYear() === currentYear;
            });

            if (endingThisMonth.length === 0) {
              document.getElementById("activeCyclesResults").innerHTML = "לא נמצאו מחזורים שמסתיימים החודש";
              enableForecastButtons();
              return;
            }

            // מיון המחזורים לפי תאריך סיום
            const sortedCycles = sortCyclesByEndDate(endingThisMonth);
            displayCycles(sortedCycles, "מחזורים שמסתיימים החודש");
            enableForecastButtons();
          })
          .withFailureHandler(function(err) {
            document.getElementById("loadingSpinner").style.display = "none";
            document.getElementById("activeCyclesResults").innerHTML = "שגיאה בטעינת מחזורים: " + err;
            enableForecastButtons();
          })
          .printActiveCycles();
      }

      function displayCycles(cycles, title) {
        let html = "<h3>" + title + "</h3>";
        html += "<table border='1' cellpadding='5' cellspacing='0' style='width:100%;'>";
        html += "<tr><th>מס'</th><th>שם מחזור</th><th>תאריך התחלה</th><th>תאריך סיום</th><th>סניף</th><th>הכנסה למפגש</th></tr>";
        
        cycles.forEach((cycle, index) => {
          html += "<tr>";
          html += "<td>" + (index + 1) + "</td>";
          
          const cycleId = cycle.CycleId || cycle.customobject1000id || '';
          if (cycleId) {
            html += "<td><a href='https://app.fireberry.com/app/record/1000/" + cycleId + 
                   "' target='_blank' style='color: #00eaff; text-decoration: underline;'>" + 
                   cycle.Name + "</a></td>";
          } else {
            html += "<td>" + cycle.Name + "</td>";
          }
          
          // תאריך התחלה
          const startDate = cycle.StartDate || cycle.pcfsystemfield33;
          const startDt = startDate ? new Date(startDate) : null;
          const startDateFormatted = startDt ? startDt.toLocaleDateString('he-IL') : '';
          html += "<td>" + startDateFormatted + "</td>";
          
          // תאריך סיום
          const endDate = cycle.EndDate || cycle.pcfsystemfield35;
          const endDt = endDate ? new Date(endDate) : null;
          const endDateFormatted = endDt ? endDt.toLocaleDateString('he-IL') : '';
          html += "<td>" + endDateFormatted + "</td>";
          
          html += "<td>" + (cycle.BranchName || '') + "</td>";
          html += "<td>₪" + (cycle.Income || '0') + "</td>";
          html += "</tr>";
        });
        
        html += "</table>";
        document.getElementById("activeCyclesResults").innerHTML = html;
      }

      function showInstitutionalOrders() {
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("institutionalOrdersResults").innerHTML = "";
        
        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById("loadingSpinner").style.display = "none";
            
            if (!response || response.length === 0) {
              document.getElementById("institutionalOrdersResults").innerHTML = "לא נמצאו הזמנות מוסדיות בסטטוס מעקב וגבייה או הסתיימה";
              enableForecastButtons();
              return;
            }

            console.log("Raw response:", response); // לדיבוג

            // מיון התוצאות לפי תאריך תחילת פעילות
            response.sort((a, b) => {
              // המרת תאריכים לאובייקטי Date
              const getDateFromString = (dateStr) => {
                if (!dateStr || dateStr === 'לא צוין') return new Date(0);
                // בדיקה אם התאריך בפורמט dd.mm.yyyy
                if (dateStr.includes('.')) {
                  const [day, month, year] = dateStr.split('.');
                  return new Date(year, month - 1, day);
                }
                // בדיקה אם התאריך בפורמט d.m.yyyy
                const parts = dateStr.split('.');
                if (parts.length === 3) {
                  return new Date(parts[2], parts[1] - 1, parts[0]);
                }
                // אם התאריך בפורמט אחר (למשל "17.9.2024")
                try {
                  return new Date(dateStr);
                } catch (e) {
                  console.error("Error parsing date:", dateStr);
                  return new Date(0);
                }
              };

              console.log("Comparing dates:", {
                dateA: a.ActivityStartDate,
                dateB: b.ActivityStartDate
              });

              const dateA = getDateFromString(a.ActivityStartDate);
              const dateB = getDateFromString(b.ActivityStartDate);

              console.log("Converted dates:", {
                dateA: dateA.toISOString(),
                dateB: dateB.toISOString()
              });

              // שינוי סדר המיון למהחדש לישן (מאוחר למוקדם)
              return dateB - dateA;
            });

            // חישוב סכומים לפי סטטוס
            let totalPaymentTracking = 0;
            let totalPaymentCompleted = 0;
            
            response.forEach(order => {
              // הדפסת פרטי ההזמנה לדיבוג
              console.log("Processing order:", {
                name: order.Name,
                status: order.Status,
                payment: order.TotalPayment,
                rawPayment: order.TotalPayment.replace(/[₪,\s]/g, '')
              });

              // ניקוי הסכום מסימן השקל, רווחים ופסיקים
              const payment = parseFloat(order.TotalPayment.replace(/[₪,\s]/g, ''));
              
              // בדיקת הסטטוס לפי הטקסט המוצג
              if (order.Status === "מעקב וגבייה") {
                totalPaymentTracking += payment;
                console.log("Added to tracking:", payment, "Total now:", totalPaymentTracking);
              } else if (order.Status === "הסתיים") {
                totalPaymentCompleted += payment;
                console.log("Added to completed:", payment, "Total now:", totalPaymentCompleted);
              }
            });

            let html = "<h3>הזמנות מוסדיות</h3>";
            
            // הצגת סיכומים
            html += "<div style='margin-bottom: 20px;'>";
            html += "<div style='padding: 10px; margin-bottom: 10px; background-color: rgba(255, 193, 7, 0.1); border-radius: 5px;'>";
            html += "<p><strong>סך הכל בסטטוס מעקב וגבייה: ₪" + 
                   totalPaymentTracking.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "</strong></p>";
            html += "</div>";
            
            html += "<div style='padding: 10px; margin-bottom: 10px; background-color: rgba(40, 167, 69, 0.1); border-radius: 5px;'>";
            html += "<p><strong>סך הכל בסטטוס הסתיים: ₪" + 
                   totalPaymentCompleted.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "</strong></p>";
            html += "</div>";
            
            html += "<div style='padding: 10px; background-color: rgba(0, 123, 255, 0.1); border-radius: 5px;'>";
            html += "<p><strong>סך הכל כללי: ₪" + 
                   (totalPaymentTracking + totalPaymentCompleted).toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "</strong></p>";
            html += "</div>";
            html += "</div>";

            html += "<table border='1' cellpadding='5' cellspacing='0' style='width:100%;'>";
            html += "<tr><th>מס'</th><th>שם ההזמנה</th><th>סניף</th><th>תשלום כולל</th><th>תאריך תחילת פעילות</th><th>סטטוס</th></tr>";
            
            response.forEach((order, index) => {
              // צבע רקע שונה לפי סטטוס
              const rowStyle = order.Status === "מעקב וגבייה" ? 
                             "background-color: rgba(255, 193, 7, 0.1);" :  // צהוב שקוף למעקב וגבייה
                             "background-color: rgba(40, 167, 69, 0.1);";   // ירוק שקוף להסתיימה
              
              html += "<tr style='" + rowStyle + "'>";
              html += "<td>" + (index + 1) + "</td>";
              
              // שם ההזמנה עם לינק
              html += "<td><a href='https://app.fireberry.com/app/record/1005/" + order.OrderId + 
                     "' target='_blank' style='color: #00eaff; text-decoration: underline;'>" + 
                     order.Name + "</a></td>";
              
              html += "<td>" + order.BranchName + "</td>";
              html += "<td>₪" + order.TotalPayment + "</td>";
              
              // הוספת תאריך תחילת פעילות
              html += "<td>" + order.ActivityStartDate + "</td>";
              
              // עיצוב הסטטוס
              const statusStyle = order.Status === "מעקב וגבייה" ?
                                "color: #ffc107; font-weight: bold;" :  // צהוב למעקב וגבייה
                                "color: #28a745; font-weight: bold;";   // ירוק להסתיימה
              
              html += "<td style='" + statusStyle + "'>" + order.Status + "</td>";
              html += "</tr>";
            });
            
            html += "</table>";
            document.getElementById("institutionalOrdersResults").innerHTML = html;
            enableForecastButtons();
          })
          .withFailureHandler(function(err) {
            document.getElementById("loadingSpinner").style.display = "none";
            document.getElementById("institutionalOrdersResults").innerHTML = "שגיאה בטעינת הזמנות מוסדיות: " + err;
            enableForecastButtons();
          })
          .printInstitutionalOrders();
      }

      function showCycleEndDateComparison() {
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("cycleEndDateResults").innerHTML = "";
        
        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById("loadingSpinner").style.display = "none";
            
            if (!response || response.length === 0) {
              document.getElementById("cycleEndDateResults").innerHTML = "לא נמצאו מחזורים עם פער בין תאריך סיום לפגישה אחרונה";
              enableForecastButtons();
              return;
            }

            let html = "<h3>מחזורים עם פער בין תאריך סיום לפגישה אחרונה</h3>";
            html += "<table border='1' cellpadding='5' cellspacing='0' style='width:100%;'>";
            html += "<tr><th>מס'</th><th>שם המחזור</th><th>תאריך סיום מתוכנן</th><th>תאריך פגישה אחרונה</th><th>פער בימים</th><th>פעולות</th></tr>";
            
            response.forEach((cycle, index) => {
              const rowStyle = cycle.DaysDiff > 7 ? 
                             "background-color: rgba(220, 53, 69, 0.1);" :  // אדום שקוף לפער גדול
                             "background-color: rgba(255, 193, 7, 0.1);";   // צהוב שקוף לפער קטן
              
              html += "<tr style='" + rowStyle + "'>";
              html += "<td>" + (index + 1) + "</td>";
              
              html += "<td><a href='https://app.fireberry.com/app/record/1000/" + cycle.CycleId + 
                     "' target='_blank' style='color: #00eaff; text-decoration: underline;'>" + 
                     cycle.Name + "</a></td>";
              
              html += "<td>" + cycle.EndDate + "</td>";
              html += "<td>" + cycle.LastMeeting + "</td>";
              
              const gapStyle = cycle.DaysDiff > 7 ?
                             "color: #dc3545; font-weight: bold;" :  // אדום לפער גדול
                             "color: #ffc107; font-weight: bold;";   // צהוב לפער קטן
              
              html += "<td style='" + gapStyle + "'>" + cycle.DaysDiff + "</td>";
              
              // הוספת כפתור עדכון
              html += "<td><button onclick='updateCycleEndDateToLastMeeting(\"" + 
                     cycle.CycleId + "\", \"" + cycle.RawLastMeetingDate + "\")' " +
                     "style='background: linear-gradient(45deg, #28a745, #20c997); color: white; " +
                     "border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;'>" +
                     "עדכן תאריך סיום</button></td>";
              
              html += "</tr>";
            });
            
            html += "</table>";

            // הוספת כפתור לעדכון כל המחזורים
            html += "<div style='margin-top: 20px; text-align: center;'>";
            html += "<button onclick='updateAllCyclesEndDates()' " +
                   "style='background: linear-gradient(45deg, #4361ee, #4cc9f0); color: white; " +
                   "border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1.1em;'>" +
                   "עדכן את כל תאריכי הסיום</button>";
            html += "</div>";

            document.getElementById("cycleEndDateResults").innerHTML = html;
            enableForecastButtons();
          })
          .withFailureHandler(function(err) {
            document.getElementById("loadingSpinner").style.display = "none";
            document.getElementById("cycleEndDateResults").innerHTML = "שגיאה בטעינת השוואת תאריכים: " + err;
            enableForecastButtons();
          })
          .printCyclesEndDateComparison();
      }

      // פונקציה חדשה לעדכון תאריך הסיום
      function updateCycleEndDateToLastMeeting(cycleId, lastMeetingDate) {
        document.getElementById("loadingSpinner").style.display = "block";
        
        google.script.run
          .withSuccessHandler(function(result) {
            document.getElementById("loadingSpinner").style.display = "none";
            if (result.success) {
              showNotification("תאריך הסיום עודכן בהצלחה");
              // רענון הטבלה
              showCycleEndDateComparison();
            } else {
              showNotification("שגיאה בעדכון תאריך הסיום: " + result.message);
            }
          })
          .withFailureHandler(function(error) {
            document.getElementById("loadingSpinner").style.display = "none";
            showNotification("שגיאה בעדכון תאריך הסיום: " + error);
          })
          .updateCycleEndDate(cycleId, lastMeetingDate);
      }

      // פונקציה חדשה לעדכון כל המחזורים
      function updateAllCyclesEndDates() {
        document.getElementById("loadingSpinner").style.display = "block";
        
        google.script.run
          .withSuccessHandler(function(result) {
            document.getElementById("loadingSpinner").style.display = "none";
            if (result.success) {
              showNotification(result.message);
              // רענון הטבלה
              showCycleEndDateComparison();
            } else {
              showNotification("שגיאה בעדכון תאריכי הסיום: " + result.message);
            }
          })
          .withFailureHandler(function(error) {
            document.getElementById("loadingSpinner").style.display = "none";
            showNotification("שגיאה בעדכון תאריכי הסיום: " + error);
          })
          .updateAllCyclesEndDates();
      }

      // פונקציות חדשות לצ'אטבוט
      function addChatMessage(message, isUser = false) {
        var chatMessages = document.getElementById("chatMessages");
        var messageDiv = document.createElement("div");
        messageDiv.className = "chat-message " + (isUser ? "user-message" : "bot-message");
        messageDiv.style.margin = "10px";
        messageDiv.style.padding = "10px";
        messageDiv.style.borderRadius = "10px";
        messageDiv.style.maxWidth = "80%";
        messageDiv.style.wordWrap = "break-word";
        
        if (isUser) {
          messageDiv.style.marginLeft = "auto";
          messageDiv.style.background = "rgba(67, 97, 238, 0.3)";
        } else {
          messageDiv.style.marginRight = "auto";
          messageDiv.style.background = "rgba(76, 201, 240, 0.3)";
        }
        
        messageDiv.textContent = message;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function sendChatMessage() {
        var input = document.getElementById("chatInput");
        var message = input.value.trim();
        if (!message) return;
        
        addChatMessage(message, true);
        input.value = "";
        document.getElementById("sendChatBtn").disabled = true;
        
        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById("sendChatBtn").disabled = false;
            if (response.success) {
              addChatMessage(response.answer);
            } else {
              addChatMessage("מצטער, אירעה שגיאה בעיבוד השאלה שלך.");
            }
          })
          .withFailureHandler(function(error) {
            document.getElementById("sendChatBtn").disabled = false;
            addChatMessage("מצטער, אירעה שגיאה: " + error);
          })
          .processChatQuery(message);
      }

      // הוספת האזנה ללחיצה על Enter בשדה הקלט
      document.getElementById("chatInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          sendChatMessage();
        }
      });

      function showDigitalRegistrations() {
        disableForecastButtons();
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("digitalRegistrationsResults").innerHTML = "";
        
        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById("loadingSpinner").style.display = "none";
            
            if (!response || response.length === 0) {
              document.getElementById("digitalRegistrationsResults").innerHTML = "לא נמצאו הרשמות לקורסים דיגיטליים";
              enableForecastButtons();
              return;
            }

            // מיון ההרשמות לפי תאריך הרשמה מהחדש לישן
            response.sort((a, b) => {
              const dateA = new Date(a.RegistrationDate.split('/').reverse().join('-'));
              const dateB = new Date(b.RegistrationDate.split('/').reverse().join('-'));
              return dateB - dateA;
            });

            // חישוב סך כל התשלומים
            let totalPayment = response.reduce((sum, reg) => {
              return sum + parseFloat(reg.Payment.replace(/[₪,\s]/g, ''));
            }, 0);

            let html = "<h3>הרשמות לקורסים דיגיטליים</h3>";
            
            // הצגת סיכום
            html += "<div style='margin-bottom: 20px;'>";
            html += "<div style='padding: 10px; background-color: rgba(0, 123, 255, 0.1); border-radius: 5px;'>";
            html += "<p><strong>סך כל ההרשמות: " + response.length + "</strong></p>";
            html += "<p><strong>סך כל התשלומים: ₪" + 
                   totalPayment.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 
                   "</strong></p>";
            html += "</div>";
            html += "</div>";

            // הצגת טבלת ההרשמות
            html += "<table border='1' cellpadding='5' cellspacing='0' style='width:100%;'>";
            html += "<tr><th>מס'</th><th>שם הקורס</th><th>תאריך הרשמה</th><th>תשלום</th></tr>";
            
            response.forEach((reg, index) => {
              html += "<tr>";
              html += "<td>" + (index + 1) + "</td>";
              
              // שם הקורס עם לינק
              html += "<td><a href='https://app.fireberry.com/app/record/14/" + reg.CourseId + 
                     "' target='_blank' style='color: #00eaff; text-decoration: underline;'>" + 
                     reg.CourseName + "</a></td>";
              
              html += "<td>" + reg.RegistrationDate + "</td>";
              html += "<td>₪" + reg.Payment + "</td>";
              html += "</tr>";
            });
            
            html += "</table>";
            document.getElementById("digitalRegistrationsResults").innerHTML = html;
            enableForecastButtons();
          })
          .withFailureHandler(function(err) {
            document.getElementById("loadingSpinner").style.display = "none";
            document.getElementById("digitalRegistrationsResults").innerHTML = "שגיאה בטעינת הרשמות לקורסים דיגיטליים: " + err;
            enableForecastButtons();
          })
          .printDigitalCourseRegistrations();
      }

    </script>
  </body>
</html>
